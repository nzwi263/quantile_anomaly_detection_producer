image: amaysim/serverless:3.21.0

stages:
  - deploy

deploy_development:
  stage: deploy
  before_script:
    - echo "Configuring container"
    - mkdir ~/.aws && touch ~/.aws/credentials
    - touch ~/.aws/config
    - touch queues.json
    - cat $AWS_CLI_CREDENTIALS >> ~/.aws/credentials
    - cat $AWS_CLI_CONFIG >> ~/.aws/config
  script:
    - echo "Deploying dev stack"
    - serverless deploy --stage $ENV_STAGE --region $AWS_REGION --param="AWS_REGION=${AWS_REGION}" --param="SQS_QUEUE_REGION=${SQS_QUEUE_REGION}" --param="SQS_QUEUE_URL=${SQS_QUEUE_URL}" --verbose
  environment: development
  only:
    - development

remove_development:
  stage: deploy
  before_script:
    - echo "Configuring container"
    - mkdir ~/.aws && touch ~/.aws/credentials
    - touch ~/.aws/config
    - touch queues.json
    - cat $AWS_CLI_CREDENTIALS >> ~/.aws/credentials
    - cat $AWS_CLI_CONFIG >> ~/.aws/config
  script:
    - echo "Removing dev stack"
    - serverless remove --stage $ENV_STAGE --region $AWS_REGION --param="AWS_REGION=${AWS_REGION}" --param="SQS_QUEUE_REGION=${SQS_QUEUE_REGION}" --param="SQS_QUEUE_URL=${SQS_QUEUE_URL}" --verbose
  environment: development
  only:
    - remove/development
